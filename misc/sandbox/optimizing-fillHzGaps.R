
library(aqp, warn = FALSE)
#> This is aqp 1.27

# original code, slightly modified relative to master
fillHzGaps <- function(x, flag = FALSE) {

  idn <- idname(x)
  hzidn <- hzidname(x)
  htb <- horizonDepths(x)
  hznames <- horizonNames(x)

  ids.top.bottom.idx <- match(c(idn, hzidn, htb), hznames)

  h <- horizons(x)

  hs <- split(h, h[[idn]])

  h.filled <- lapply(hs, function(i) {
    n <- nrow(i)

    s <- 1:(n-1)

    .top <- i[[htb[1]]]
    .bottom <- i[[htb[2]]]
    idx <- which(.bottom[s] != .top[s + 1])

    if(length(idx) > 0) {
      gap.top <- .bottom[idx]
      gap.bottom <- .top[idx + 1]

      hz.template <- i[1, ids.top.bottom.idx]
      hz.template[[htb[1]]] <- gap.top
      hz.template[[htb[2]]] <- gap.bottom
      hz.template[[hzidn]] <- NA
      res <- data.table::rbindlist(list(i, hz.template), fill = TRUE)
      res <- as.data.frame(res)
      return(res)
    } else {
      return(i)
    }

  })

  h.filled <- do.call('rbind', h.filled)
  o <- order(h.filled[[idn]], h.filled[[htb[1]]])
  h.filled <- h.filled[o, ]
  idx <- which(is.na(h.filled[[hzidn]]))

  if(length(idx) > 0) {
    m <- max(as.numeric(h[[hzidn]]), na.rm = TRUE)
    s <- seq(
      from = m + 1,
      to = m + length(idx),
      by = 1
    )

    if(flag) {
      h.filled[['.filledGap']] <- FALSE
      h.filled[['.filledGap']][idx] <- TRUE
    }

    h.filled[[hzidn]][idx] <- as.character(s)
  }

  # note: this is the right place to deal with hzid
  h.filled$hzID <- as.character(1:nrow(h.filled))
  replaceHorizons(x) <- aqp:::.as.data.frame.aqp(h.filled, aqp_df_class(x))
  hzidname(x) <- "hzID"

  return(x)
}

# new code
fillHzGaps_2 <- function(x, flag = FALSE) {
  idn <- idname(x)
  hzidn <- hzidname(x)

  htb <- horizonDepths(x)

  hznames <- horizonNames(x)
  hcnames <- c(idn, hzidn, htb)

  h <- horizons(x)

  lead.idx <- 2:nrow(h)
  lag.idx <- 1:(nrow(h) - 1)

  # identify bad horizons
  bad.idx <- which(h[[htb[2]]][lag.idx] != h[[htb[1]]][lead.idx]
                   & h[[idn]][lag.idx] == h[[idn]][lead.idx])

  # create template data.frame
  hz.template <- h[bad.idx, ]

  # replace non-ID/depth column values with NA
  hz.template[, hznames[!hznames %in% hcnames]] <- NA

  # fill gaps
  hz.template[[htb[1]]] <- h[[htb[2]]][bad.idx]     # replace top with (overlying) bottom
  hz.template[[htb[2]]] <- h[[htb[1]]][bad.idx + 1] # replace bottom with (underlying) top

  # flag if needed
  if (flag) {
    h[['.filledGap']] <- FALSE
    hz.template[['.filledGap']] <- TRUE
  }

  # combine original data with filled data
  res <- rbind(h, hz.template)

  # ID + top depth sort
  res <- res[order(res[[idn]], res[[htb[1]]]),]

  # re-calculate unique hzID (note: AFTER reorder)
  res$hzID <- as.character(1:nrow(res))

  # replace horizons (use df class in object x)
  replaceHorizons(x) <- aqp:::.as.data.frame.aqp(res, aqp_df_class(x))

  # use the autocalculated hzID (in case user had e.g. phiid, chiid set)
  hzidname(x) <- "hzID"

  return(x)
}

fillHzGaps_3 <- function(x, flag = FALSE) {
  idn <- idname(x)
  hzidn <- hzidname(x)

  htb <- horizonDepths(x)

  hznames <- horizonNames(x)
  hcnames <- c(idn, htb)

  .SD <- NULL
  .N <- NULL
  h <- data.table::as.data.table(horizons(x))

  bad.idx <- which(h[, .SD[1:(.N - 1), 3] != .SD[2:.N, 2] &
                       .SD[1:(.N - 1), 1] == .SD[2:.N, 1],
                     .SDcols = hcnames])

  # create template data.frame
  hz.template <- h[bad.idx, ]

  # replace non-ID/depth column values with NA
  hz.template[, hznames[!hznames %in% hcnames]] <- NA

  # fill gaps
  hz.template[[htb[1]]] <- h[[htb[2]]][bad.idx]     # replace top with (overlying) bottom
  hz.template[[htb[2]]] <- h[[htb[1]]][bad.idx + 1] # replace bottom with (underlying) top

  # flag if needed
  if (flag) {
    h[['.filledGap']] <- FALSE
    hz.template[['.filledGap']] <- TRUE
  }

  # combine original data with filled data
  res <- rbind(h, hz.template)

  # ID + top depth sort
  res <- res[order(res[[idn]], res[[htb[1]]]),]

  # re-calculate unique hzID (note: AFTER reorder)
  res$hzID <- as.character(1:nrow(res))

  # replace horizons (use df class in object x)
  replaceHorizons(x) <- aqp:::.as.data.frame.aqp(res, aqp_df_class(x))

  # use the autocalculated hzID (in case user had e.g. phiid, chiid set)
  hzidname(x) <- "hzID"

  return(x)
}


# create sample dataset
spc <- as.data.frame(data.table::rbindlist(lapply(1:10000, random_profile)))
depths(spc) <- id ~ top + bottom

# introduce gaps
idx <- sample(1:nrow(spc), 100)
spc$top[idx] <- NA

# check
horizons(spc)[idx, ]
#>         id top bottom name          p1           p2           p3           p4
#> 24684 5954  NA     74   H5  14.0540331   9.65970463   9.41422034  -5.27276292
#> 7214  2453  NA     25   H1   4.9190398   7.76657352  12.95851878  -1.95328267
#> 44419 9905  NA     29   H2  27.8600210  33.62085374   1.52252831  -7.83182447
#> 35332 8082  NA     93   H5 -30.4125780   8.47228462   3.84037579  -3.64634793
#> 860    117  NA     68   H4  -5.4561210   5.84365732  -4.80942313 -13.24306127
#> 12647 3535  NA    134   H6   6.7139160 -12.25063917  15.34482959 -41.28659931
#> 22995 5615  NA      6   H1  -9.0355798   6.94705624   7.57447681  -8.17558019
#> 22515 5518  NA    105   H4  -3.7124473  -5.49255645 -37.61425390   1.21177298
#> 33852 7787  NA     14   H1 -12.2897755  -5.77211544   4.66008752  -2.43643150
#> 17808 4572  NA      9   H1  -3.8788733   3.57351439   4.33821936 -14.45105438
#> 23634 5745  NA    127   H6  14.3487085 -11.42625210   0.41622519  23.69422724
#> 21890 5393  NA     27   H1  -1.5895646  -1.25452029  11.37753147  -4.01679367
#> 5703  2144  NA     67   H3  -9.9440920  -3.49200115  -5.19046876  34.87043287
#> 36833 8388  NA     57   H2   2.5278344   0.74724235   6.40975401  -9.19301006
#> 18606 4732  NA    117   H6  42.7695635  10.13841916 -46.23844645 -23.11715759
#> 15421 4088  NA     81   H5  23.7648347 -36.41128063  -4.76435009  10.95535349
#> 5804  2165  NA     30   H1  -1.9787191  -6.24892278  -3.13065072  -0.81358974
#> 40293 9083  NA     16   H1  -8.0707267   7.95116438   1.47618184   6.77181082
#> 688   1135  NA     31   H3  13.6369619   0.79011806   7.48779138   3.18014229
#> 18843 4782  NA     58   H4  -9.1440991  13.69680872  -5.60979333 -28.74702631
#> 17016  441  NA     76   H6  30.6194420  -2.21073466  -1.24694346  -3.59855140
#> 5495  2104  NA     39   H3 -15.8182612 -15.36340783   7.93024764  13.60221873
#> 43643  975  NA     76   H5   0.9962217  37.09202843  17.06191127 -16.79689870
#> 10194 3044  NA     29   H2   8.1343855  -6.19080073  10.95267926   8.28032506
#> 3272  1651  NA     91   H4  -0.8482762 -18.28439125   0.48236455  10.17122195
#> 37871   86  NA     27   H2   1.3875302  12.21278611   7.23259732  19.83119569
#> 22906 5598  NA     46   H4   3.0200833   8.50983139   3.92222852 -39.14519724
#> 9270  2862  NA     16   H1 -14.9198614   4.71863836   6.16511658   5.01816836
#> 44579 9939  NA     22   H1   1.6200099  -7.71534955   2.33516486 -12.68950091
#> 34446 7904  NA     36   H2  12.0847016  -6.71893755  26.12003669   3.94522270
#> 15053 4013  NA      7   H1   7.3972779   0.01012093   6.09193698  15.09731845
#> 40948  921  NA     27   H1   0.3744517  12.80905013  -2.88094278 -17.19849559
#> 2027  1403  NA     57   H3 -17.4486636  -7.64863842  -7.02851544  -4.89629284
#> 4202   184  NA     30   H3  -6.4021443  -5.06044356  11.87052676  -9.12132763
#> 21959 5405  NA     22   H1   4.4958820   5.96028376 -11.01250298  18.58636095
#> 25626 6143  NA     46   H2  16.8056343   4.14858509  27.41979645  -7.04311775
#> 31477 7307  NA     65   H3  11.0415185  -9.37773965 -14.54382890   4.04921039
#> 31437   73  NA     18   H1  -5.7445214   4.88185857  11.52006593  -4.66472757
#> 41145 9248  NA     98   H5  25.1744072   5.93215809   0.49027538   3.51319551
#> 27682 6556  NA     40   H5  12.1599613 -33.50579563 -21.82223178  -1.17651920
#> 10518 3110  NA     34   H2   2.0131421  15.72194085  -2.25868747  -3.98357475
#> 30925 7197  NA     24   H1  -5.1440413   5.24906799  -0.92694480  -0.03406939
#> 3439  1685  NA     59   H3 -11.9993663  -0.60666095  13.16328264 -10.21545731
#> 35044 8021  NA     10   H1  -5.2585057   8.51787367  -3.75235557  -9.67021895
#> 26682 6358  NA     41   H2  -6.6077758  -5.19544181 -15.21335893   0.27960092
#> 44736 9969  NA     59   H3 -15.1053641   3.25310799  18.85127832 -12.89047730
#> 44782 9978  NA     60   H3  17.6536634 -11.73174724 -15.04885210  11.55098690
#> 31886 7389  NA     37   H2  -8.9785744   4.63015054  -9.66194976  -7.97723613
#> 11683 3342  NA     40   H2 -11.6724374 -10.50368158   1.92767624  -4.26008307
#> 16028  421  NA     29   H1  -6.0526280 -13.92798300  -2.03924953  16.07431176
#> 27918 6600  NA     14   H1   2.3129866   6.89769448 -15.30055829  -9.38472408
#> 13575 3719  NA     13   H1  -6.9592394   8.58674592   7.02771560  -0.90392785
#> 38432 8708  NA     40   H3   2.5393477   8.97087866 -18.47772700  13.56716528
#> 30826 7176  NA     57   H4   2.3926574 -11.09379592   3.39242853   2.21437917
#> 17700  455  NA     56   H4 -25.3055100 -32.58015773  14.78087659  -8.09982578
#> 31832 7378  NA     23   H1   3.4671825   0.19927819  21.07045396   2.95863142
#> 15716 4148  NA    121   H6 -16.0731201  35.53691696  21.76444212 -19.16863621
#> 9519   291  NA     63   H4   4.9424033 -42.97501832  -2.96744613  -7.85069939
#> 31026 7215  NA     80   H4 -38.9565679  12.26435661 -11.91982420  23.78134553
#> 34854 7987  NA     29   H1   7.1869867   0.21973192   1.57836241  -3.34007453
#> 20547 5127  NA     23   H2 -18.3562874   3.11130615  -4.42833131  -1.93444201
#> 1973  1393  NA     18   H1   6.4960464   1.96448368   0.34556060   7.52379756
#> 18699 4751  NA     82   H5 -26.3065269  13.02116763   4.48044648  24.96131330
#> 41507 9324  NA     36   H2 -15.0131608  -0.42497869   0.02441316   6.67000876
#> 28970 6805  NA     59   H3 -13.6131944  15.61082088 -15.11947076   2.28975526
#> 11349 3278  NA     99   H4   8.2108997   2.40503434  -5.26931186  11.38486866
#> 29282 6869  NA     86   H4  10.1468544   7.98714937 -27.79279249 -21.65332958
#> 14684 3944  NA     63   H3  10.5199438  22.07149818   2.28790759  -2.84027215
#> 10528 3111  NA     94   H6   5.1727853 -16.61857989 -15.45325616  28.28719575
#> 36005 8217  NA     81   H4  20.0044163 -16.71462993  14.84874854   7.38502550
#> 1499    13  NA     25   H1  -2.0666553  -1.00035035  -7.42221910 -10.20578064
#> 21828 5381  NA     49   H3 -17.7674604  13.97266549  -3.15820461 -31.37771050
#> 16785 4362  NA     41   H2  -2.8146129   7.32606366 -16.30417086   5.72025649
#> 811   1160  NA     12   H1  11.6458328  -3.43504326 -12.89149865  -1.07788396
#> 1616  1320  NA     64   H4   0.9717888 -31.02289587 -20.48046176 -10.54753406
#> 42795 9580  NA     80   H4 -10.2816007  -7.59768391   5.14041711  30.45253983
#> 28365 6687  NA     23   H2  14.0199586 -16.06373261  19.95241772  -0.40041504
#> 11269 3260  NA     29   H1   4.8555200  -4.90678875  -2.88043608  11.99213303
#> 36100 8238  NA     22   H2  -2.3388895   1.39294111 -11.19008876   1.65339985
#> 21289 5274  NA     45   H3  -7.4255913  24.64570924  -3.97670870 -10.79360303
#> 20590 5137  NA     37   H2 -10.4996393  -4.19133577  -0.11521332   6.07549631
#> 18852 4784  NA     31   H2  10.0882751   1.63590082   1.90285834  -9.16841897
#> 19745 4964  NA     55   H3 -25.1521570   4.36793296   3.02841565 -10.62368619
#> 7980   260  NA     63   H4 -27.5478178   0.22148628   8.21937940   8.04925219
#> 25937 6205  NA     75   H3  -9.7508705  10.00984891 -23.72866853  -8.52984574
#> 8059  2619  NA     25   H1 -10.3757502   8.30334588 -14.34631903   0.27029214
#> 32505 7510  NA     44   H2 -16.0315493   3.24668360  -0.12903913  -7.32416912
#> 14116 3831  NA     63   H5  13.0401611 -11.69809363 -12.88609762   0.78025061
#> 1300  1258  NA     63   H3 -10.5413332   5.51027181   4.18102143   2.57428613
#> 9888  2987  NA     24   H1  10.9242878   6.90385418  -1.56917782   1.82237918
#> 37795 8583  NA     83   H4 -10.6679014   7.35015188   1.68965735  33.96520853
#> 37317 8484  NA     27   H1   6.1567760  -6.58805279  -9.18594394  -8.68658830
#> 22441 5503  NA     43   H3   9.1079579  28.42912739  -7.26429909  16.84856420
#> 34613 7937  NA     26   H2  -9.2570865  -6.30197605   6.15672282   2.75934603
#> 25851 6188  NA    100   H5  -3.8052799  18.57796711 -10.30659348   4.17612483
#> 16654 4334  NA     31   H2 -11.5549847   4.14178736  -1.60403609   5.02125382
#> 7532  2516  NA     14   H1   6.4596195  -7.30918511  11.28964911  -3.79211861
#> 44487 9920  NA     42   H2  -7.1818543  -4.87056255 -15.94996349  -4.75314169
#> 6471  2298  NA     21   H1  -0.9298580   5.70934851   0.07020839 -12.39295062
#> 31799  737  NA     42   H4 -26.5116137   1.15688749  25.75036644  -3.72596975
#>                p5  hzID
#> 24684 -15.9118011 24684
#> 7214   -0.6357776  7214
#> 44419  10.6639583 44419
#> 35332  -5.9228417 35332
#> 860     8.8921497   860
#> 12647 -18.7586824 12647
#> 22995  -0.2278884 22995
#> 22515   1.7821648 22515
#> 33852 -10.7544851 33852
#> 17808  -3.9939909 17808
#> 23634  10.1476480 23634
#> 21890  18.9741190 21890
#> 5703  -14.2670791  5703
#> 36833   2.7748556 36833
#> 18606 -29.7143649 18606
#> 15421   7.0069903 15421
#> 5804  -12.0205533  5804
#> 40293  19.9811366 40293
#> 688    -9.7029119   688
#> 18843 -18.8998911 18843
#> 17016 -19.0222724 17016
#> 5495  -25.0019410  5495
#> 43643   9.5962553 43643
#> 10194  13.5495517 10194
#> 3272   28.6174521  3272
#> 37871   2.4521116 37871
#> 22906  -8.4872850 22906
#> 9270   -4.6857509  9270
#> 44579  -5.1780976 44579
#> 34446  -6.1458329 34446
#> 15053  -1.8537963 15053
#> 40948  -7.7067605 40948
#> 2027   -4.8998634  2027
#> 4202    0.1049795  4202
#> 21959 -26.6620503 21959
#> 25626   8.6830968 25626
#> 31477  -5.0816038 31477
#> 31437  -8.3005394 31437
#> 41145   1.1500111 41145
#> 27682  -9.3506928 27682
#> 10518  18.3825628 10518
#> 30925  -8.6050371 30925
#> 3439   13.7957147  3439
#> 35044  23.9529885 35044
#> 26682  -2.1123217 26682
#> 44736 -17.9794198 44736
#> 44782   4.1347534 44782
#> 31886  -6.8105919 31886
#> 11683  -3.2055855 11683
#> 16028  -0.7614844 16028
#> 27918  -5.1761409 27918
#> 13575 -11.0483815 13575
#> 38432  -6.6577810 38432
#> 30826  -9.7289456 30826
#> 17700   7.0451733 17700
#> 31832  -1.0756081 31832
#> 15716  27.7216996 15716
#> 9519   25.8086890  9519
#> 31026 -29.1720644 31026
#> 34854  -1.1348132 34854
#> 20547  10.2087770 20547
#> 1973  -13.3749989  1973
#> 18699  21.2916188 18699
#> 41507  -2.8333731 41507
#> 28970  -5.9626807 28970
#> 11349  31.9269777 11349
#> 29282  -5.8988343 29282
#> 14684   6.0639169 14684
#> 10528 -26.4552711 10528
#> 36005  -6.8799011 36005
#> 1499   -4.4528170  1499
#> 21828   2.1069002 21828
#> 16785  -4.9678001 16785
#> 811   -13.5843361   811
#> 1616    7.7805638  1616
#> 42795  14.9932584 42795
#> 28365  10.5466129 28365
#> 11269  -2.5283924 11269
#> 36100   3.6175567 36100
#> 21289  17.0056580 21289
#> 20590  -6.2572432 20590
#> 18852  -1.3965271 18852
#> 19745 -10.6902800 19745
#> 7980   -0.6452720  7980
#> 25937   5.6993842 25937
#> 8059    6.6835837  8059
#> 32505   8.9773453 32505
#> 14116   8.7640687 14116
#> 1300  -17.5160266  1300
#> 9888   -0.8947802  9888
#> 37795 -13.4793454 37795
#> 37317   3.0447456 37317
#> 22441  -9.5342922 22441
#> 34613   4.0669198 34613
#> 25851  -7.2668172 25851
#> 16654 -11.3178374 16654
#> 7532   -1.2088228  7532
#> 44487  -8.7216958 44487
#> 6471    0.3605372  6471
#> 31799  25.0158588 31799

# remove problematic horizons
x <- HzDepthLogicSubset(spc, byhz = TRUE)
#> dropping horizons with invalid depth logic, see `metadata(x)$removed.horizons`

# benchmark filling gaps
bench::mark(horizons(fillHzGaps(x, flag = TRUE)),
            horizons(fillHzGaps_2(x, flag = TRUE)),
            horizons(fillHzGaps_3(x, flag = TRUE)))
#> Warning: Some expressions had a GC in every iteration; so filtering is disabled.
#> # A tibble: 3 x 6
#>   expression                                  min   median `itr/sec` mem_alloc
#>   <bch:expr>                             <bch:tm> <bch:tm>     <dbl> <bch:byt>
#> 1 horizons(fillHzGaps(x, flag = TRUE))      3.28s    3.28s     0.305        NA
#> 2 horizons(fillHzGaps_2(x, flag = TRUE)) 120.73ms 133.68ms     7.53         NA
#> 3 horizons(fillHzGaps_3(x, flag = TRUE))  35.31ms  41.04ms    19.7          NA
#> # … with 1 more variable: `gc/sec` <dbl>
